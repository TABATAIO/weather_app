<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>ãƒã‚¹ã‚³ãƒƒãƒˆãƒšãƒ¼ã‚¸ - å¤©æ°—äºˆå ±ã‚¢ãƒ—ãƒª (Updated: 2026-02-01 17:25)</title>
    <link rel="stylesheet" href="css/destyle.css" />
    <link rel="stylesheet" href="css/mascotPage.css" />
  </head>
  <body>
    <!-- å¤©æ°—èƒŒæ™¯ã‚³ãƒ³ãƒ†ãƒŠï¼ˆJavaScriptã§å‹•çš„ã«è¿½åŠ ï¼‰ -->

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
      <button class="back-button" id="backButton">
        <span class="back-arrow">â†</span>
      </button>
      <div class="weather-info" id="weatherInfo">
        <span class="current-time" id="currentTime">9:41</span>
      </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
      <!-- AIã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º -->
      <div class="ai-comment-container">
        <div class="ai-comment" id="aiComment">
          <span id="mascot-name-comment">ã‹ã‚‰ã‚ã‚‹</span>ã®æ™´ã‚Œã—ã®ãŠã—ã‚ƒã¹
        </div>
      </div>

      <!-- ãƒã‚¹ã‚³ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div class="mascot-container">
        <a href="chatPage.html" class="mascot-link">
          <div class="mascot" id="mascot">
            <div class="mascot-body" id="mascot-animation"></div>
            <!-- ãƒãƒ¼ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
            <div class="heart-effects" id="heartEffects"></div>
          </div>
        </a>

        <!-- ã‚¿ãƒƒãƒã‚¬ã‚¤ãƒ‰ -->
        <div class="touch-guide" id="touchGuide">ã‚¿ãƒƒãƒã§ãƒãƒ£ãƒƒãƒˆé–‹å§‹ï¼ï¼</div>

        <!-- ãƒã‚¹ã‚³ãƒƒãƒˆã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆãƒã‚¹ã‚³ãƒƒãƒˆç›´ä¸‹ï¼‰ -->
        <div class="mascot-interaction-buttons">
          <!-- é¤Œã‚„ã‚Šãƒœã‚¿ãƒ³ã¨ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ -->
          <div class="feed-button-container">
            <button class="interaction-btn feed-btn" id="feedButton">
              <span class="btn-icon">ğŸ™</span>
              <span class="btn-text">é¤Œã‚’ã‚ã’ã‚‹</span>
            </button>

            <!-- é¤Œé¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ -->
            <div class="feed-dropdown" id="feedDropdown">
              <div class="dropdown-header">é¤Œã‚’é¸æŠ</div>
              <div
                class="feed-option"
                data-food="riceball"
                data-effect="â¤ï¸"
                data-fullness="20"
              >
                <span class="food-icon">ğŸ™</span>
                <span class="food-name">ãŠã«ãã‚Š</span>
                <span class="food-effect">æº€è…¹+2</span>
              </div>
              <div
                class="feed-option"
                data-food="bread"
                data-effect="ğŸ’"
                data-fullness="15"
              >
                <span class="food-icon">ğŸ</span>
                <span class="food-name">ãƒ‘ãƒ³</span>
                <span class="food-effect">æº€è…¹+1.5</span>
              </div>
              <div
                class="feed-option"
                data-food="apple"
                data-effect="ğŸ’š"
                data-fullness="10"
              >
                <span class="food-icon">ğŸ</span>
                <span class="food-name">ã‚Šã‚“ã”</span>
                <span class="food-effect">æº€è…¹+1</span>
              </div>
              <div
                class="feed-option"
                data-food="candy"
                data-effect="âœ¨"
                data-fullness="5"
              >
                <span class="food-icon">ğŸ­</span>
                <span class="food-name">ã‚­ãƒ£ãƒ³ãƒ‡ã‚£</span>
                <span class="food-effect">æ°—åˆ†UP</span>
              </div>
            </div>
          </div>

          <!-- æ’«ã§ã‚‹ãƒœã‚¿ãƒ³ -->
          <button class="interaction-btn pet-btn" id="petButton">
            <span class="btn-icon">âœ‹</span>
            <span class="btn-text">æ’«ã§ã‚‹</span>
          </button>
        </div>
      </div>

      <!-- ãƒã‚¹ã‚³ãƒƒãƒˆçŠ¶æ…‹è¡¨ç¤º -->
      <div class="mascot-status">
        <div class="status-card">
          <h3>
            <span id="mascot-name-title">ã‹ã‚‰ã‚ã‚‹</span>
            <button class="edit-name-btn">âœï¸</button>
          </h3>

          <!-- ãƒ¬ãƒ™ãƒ«è¡¨ç¤º -->
          <div class="status-item level-item">
            <span class="status-icon">â˜ï¸</span>
            <span class="status-label" id="mascot-level">Lv.1</span>
            <div class="progress-container">
              <div class="progress-bar" id="level-bar">
                <div
                  class="progress-fill"
                  id="level-fill"
                  style="width: 60%"
                ></div>
              </div>
            </div>
          </div>

          <!-- ä½“åŠ›è¡¨ç¤º -->
          <div class="status-item health-item">
            <span class="status-icon">â¤ï¸</span>
            <span class="status-label">ä½“åŠ›</span>
            <div class="progress-container">
              <div class="progress-bar" id="health-bar">
                <div
                  class="progress-fill health-fill high"
                  id="health-fill"
                  style="width: 100%"
                ></div>
              </div>
            </div>
          </div>

          <!-- ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼ˆæº€è…¹åº¦ï¼‰è¡¨ç¤º -->
          <div class="status-item energy-item">
            <span class="status-icon">ğŸ´</span>
            <span class="status-label">ãŠè…¹ã™ã„ãŸ</span>
            <div class="fullness-stars">
              <span class="fullness-star filled">â­</span>
              <span class="fullness-star">â˜†</span>
              <span class="fullness-star">â˜†</span>
              <span class="fullness-star">â˜†</span>
            </div>
          </div>

          <!-- æ°—åˆ†è¡¨ç¤º -->
          <div class="status-item mood-item">
            <span class="status-icon">ğŸ˜Š</span>
            <span class="status-label" id="mascot-mood">éŠã³ãŸã„æ°—åˆ†ï¼</span>
          </div>
        </div>
      </div>

      <!-- ãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤º -->
      <div class="mission-section">
        <div class="mission-card">
          <h3>
            ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³
            <span id="mission-loading" style="display: none">ğŸ”„</span>
          </h3>
          <div class="mission-list" id="mission-list">
            <div class="loading-message">
              Laravelã‹ã‚‰ãƒŸãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ä¸­...
            </div>
            <!-- ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¯Laravelã‹ã‚‰å‹•çš„ã«è¿½åŠ  -->
          </div>
        </div>
      </div>

      <script>
        // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        document.addEventListener("DOMContentLoaded", function () {
          setupInteractionButtons();
        });

        function setupInteractionButtons() {
          console.log("ğŸ”§ setupInteractionButtons é–‹å§‹");

          // APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆçŠ¶æ…‹ç¢ºèª
          console.log("ğŸ” åˆæœŸåŒ–æ™‚ APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆçŠ¶æ…‹:");
          console.log("- window.apiClientå­˜åœ¨:", !!window.apiClient);
          console.log("- window.apiClientå‹:", typeof window.apiClient);

          const feedButton = document.getElementById("feedButton");
          const petButton = document.getElementById("petButton");
          const feedDropdown = document.getElementById("feedDropdown");

          // é¤Œãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³è¡¨ç¤º/éè¡¨ç¤º
          if (feedButton) {
            feedButton.addEventListener("click", function (e) {
              e.preventDefault();
              toggleFeedDropdown();
            });
          }

          // æ’«ã§ã‚‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
          if (petButton) {
            petButton.addEventListener("click", function (e) {
              e.preventDefault();
              handlePetClick();
            });
          }

          // é¤Œé¸æŠã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯
          const feedOptions = document.querySelectorAll(".feed-option");
          feedOptions.forEach((option) => {
            option.addEventListener("click", function (e) {
              e.preventDefault();
              const foodType = this.dataset.food;
              const effectHeart = this.dataset.effect;
              const fullnessValue = parseInt(this.dataset.fullness) || 20;
              handleFeedClick(foodType, effectHeart, fullnessValue);
              hideFeedDropdown();
            });
          });

          // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
          document.addEventListener("click", function (e) {
            const feedContainer = document.querySelector(
              ".feed-button-container",
            );
            if (feedContainer && !feedContainer.contains(e.target)) {
              hideFeedDropdown();
            }
          });

          // åå‰ç·¨é›†ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
          const editNameButton = document.querySelector(".edit-name-btn");
          if (editNameButton) {
            editNameButton.addEventListener("click", function (e) {
              e.preventDefault();
              handleEditNameClick();
            });
          }
        }

        // é¤Œãƒ—ãƒ«ãƒ€ã‚¦ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleFeedDropdown() {
          const dropdown = document.getElementById("feedDropdown");
          if (dropdown) {
            dropdown.classList.toggle("show");
          }
        }

        // é¤Œãƒ—ãƒ«ãƒ€ã‚¦ãƒ³éè¡¨ç¤º
        function hideFeedDropdown() {
          const dropdown = document.getElementById("feedDropdown");
          if (dropdown) {
            dropdown.classList.remove("show");
          }
        }

        // é¤Œã‚„ã‚Šã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        async function handleFeedClick(foodType, effectHeart, fullnessValue) {
          console.log("ğŸ™ é¤Œã‚„ã‚Š:", foodType, effectHeart, fullnessValue);

          if (
            window.mascotDisplay &&
            typeof window.mascotDisplay.handleFeedAction === "function"
          ) {
            await window.mascotDisplay.handleFeedAction(
              foodType,
              effectHeart,
              fullnessValue,
            );
          } else {
            console.warn("âš ï¸ MascotDisplay.handleFeedAction ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }
        }

        // æ’«ã§ã‚‹ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        async function handlePetClick() {
          console.log("âœ‹ æ’«ã§ã‚‹å®Ÿè¡Œ");

          if (
            window.mascotDisplay &&
            typeof window.mascotDisplay.handlePetAction === "function"
          ) {
            await window.mascotDisplay.handlePetAction();
          } else {
            console.warn("âš ï¸ MascotDisplay.handlePetAction ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }
        }

        // åå‰ç·¨é›†ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        async function handleEditNameClick() {
          console.log("âœï¸ åå‰ç·¨é›†é–‹å§‹");

          try {
            // ç¾åœ¨ã®åå‰ã‚’å–å¾—
            const currentNameElement =
              document.getElementById("mascot-name-title");
            const currentName = currentNameElement
              ? currentNameElement.textContent.trim()
              : "ã‹ã‚‰ã‚ã‚‹";

            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§æ–°ã—ã„åå‰ã‚’å…¥åŠ›
            const newName = prompt(
              "ãƒã‚¹ã‚³ãƒƒãƒˆã®æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:",
              currentName,
            );

            if (newName === null) {
              console.log("åå‰å¤‰æ›´ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ");
              return;
            }

            if (newName.trim() === "") {
              alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
              return;
            }

            if (newName.trim().length > 20) {
              alert("åå‰ã¯20æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
              return;
            }

            if (newName.trim() === currentName) {
              console.log("åå‰ã«å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“");
              return;
            }

            console.log(
              "ğŸ”„ åå‰æ›´æ–°ä¸­...",
              `"${currentName}" â†’ "${newName.trim()}"`,
            );

            // ã¾ãšAPIæ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
            console.log("ğŸ§ª APIæ¥ç¶šãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...");
            const connectionTest = await testApiConnection();
            console.log("ğŸ” APIæ¥ç¶šãƒ†ã‚¹ãƒˆçµæœ:", connectionTest);

            // ç›´æ¥fetch APIã§ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ã‚’è©¦è¡Œ
            try {
              console.log("ğŸŒ ç›´æ¥APIå‘¼ã³å‡ºã—é–‹å§‹...");

              const response = await fetch(
                "http://localhost:8000/api/mascot/update-name",
                {
                  method: "POST",
                  headers: {
                    Accept: "application/json",
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    name: newName.trim(),
                  }),
                },
              );

              console.log("ğŸ“¡ ç›´æ¥API ãƒ¬ã‚¹ãƒãƒ³ã‚¹:", {
                status: response.status,
                statusText: response.statusText,
                ok: response.ok,
                url: response.url,
                headers: Object.fromEntries(response.headers.entries()),
              });

              if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error("âŒ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼è©³ç´°:", errorData);
                throw new Error(
                  errorData.message ||
                    `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`,
                );
              }

              const data = await response.json();
              console.log("ğŸ“¥ ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:", data);

              if (data.success) {
                console.log("âœ… åå‰æ›´æ–°æˆåŠŸ:", data.data);
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚åŒæœŸ
                localStorage.setItem("mascotName", newName.trim());
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆStorage.jsç‰ˆï¼‰ã‚‚åŒæœŸ
                if (typeof Storage !== "undefined" && Storage.set) {
                  Storage.set("mascot-name", newName.trim());
                }
                updateMascotNameInUI(newName.trim());
                alert(
                  `åå‰ã‚’ã€Œ${newName.trim()}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸï¼\nâœ… ã‚µãƒ¼ãƒãƒ¼ã«æ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚`,
                );
              } else {
                throw new Error(data.message || "åå‰æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
              }
            } catch (serverError) {
              console.error("âŒ ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ã‚¨ãƒ©ãƒ¼:", {
                message: serverError.message,
                stack: serverError.stack,
                type: serverError.constructor.name,
                connectionTest: connectionTest,
              });

              // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã‚’åˆ¤å®š
              let errorMessage = "";
              if (
                serverError.message.includes("Failed to fetch") ||
                serverError.message.includes("NetworkError")
              ) {
                errorMessage = `ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ\nğŸ” Docker ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„\nğŸ” http://localhost:8000 ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„`;
              } else if (serverError.message.includes("404")) {
                errorMessage = `API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼: /api/mascot/update-name ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\nğŸ” Laravel API ãŒæ­£ã—ãèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„`;
              } else if (serverError.message.includes("500")) {
                errorMessage = `ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã‚¨ãƒ©ãƒ¼: ${serverError.message}\nğŸ” Laravel ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„`;
              } else {
                errorMessage = `APIé€šä¿¡ã‚¨ãƒ©ãƒ¼: ${serverError.message}`;
              }

              console.warn(
                "âš ï¸ ã‚µãƒ¼ãƒãƒ¼æ›´æ–°å¤±æ•—ã€ãƒ­ãƒ¼ã‚«ãƒ«æ›´æ–°ã®ã¿å®Ÿè¡Œ:",
                errorMessage,
              );

              // ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ãŒå¤±æ•—ã—ãŸå ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«UIã®ã¿æ›´æ–°
              updateMascotNameInUI(newName.trim());
              alert(
                `åå‰ã‚’ã€Œ${newName.trim()}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸï¼\n\nâš ï¸ æ³¨æ„: ${errorMessage}\n\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹ã¨å…ƒã«æˆ»ã‚Šã¾ã™ã€‚`,
              );
            }
          } catch (error) {
            console.error("âŒ åå‰ç·¨é›†ã‚¨ãƒ©ãƒ¼:", error);
            alert("åå‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
          }
        }

        // æ—§APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå¾…æ©Ÿé–¢æ•°ï¼ˆæœªä½¿ç”¨ï¼‰
        /*
            async function waitForApiClient(maxWaitTime = 3000) {
                console.log('â³ APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ã‚’å¾…æ©Ÿä¸­...');
                const startTime = Date.now();
                let attempt = 0;

                while (Date.now() - startTime < maxWaitTime) {
                    attempt++;

                    const clientExists = !!window.apiClient;
                    const methodExists = window.apiClient && typeof window.apiClient.updateMascotName === 'function';

                    console.log(`ğŸ”„ APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå¾…æ©Ÿä¸­ [${attempt}]:`, {
                        apiClientExists: clientExists,
                        updateMascotNameExists: methodExists,
                        apiClientType: typeof window.apiClient,
                        elapsed: Date.now() - startTime,
                        availableMethods: clientExists ? Object.getOwnPropertyNames(window.apiClient).filter(name => typeof window.apiClient[name] === 'function') : []
                    });

                    if (clientExists && methodExists) {
                        console.log('âœ… APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæº–å‚™å®Œäº†');
                        return;
                    }

                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                console.error('âŒ APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ:', {
                    maxWaitTime,
                    finalState: {
                        apiClient: !!window.apiClient,
                        apiClientType: typeof window.apiClient,
                        updateMascotName: window.apiClient ? typeof window.apiClient.updateMascotName : 'N/A',
                        allGlobalVars: Object.keys(window).filter(key => key.toLowerCase().includes('api'))
                    }
                });

                throw new Error(`APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒ${maxWaitTime}msä»¥å†…ã«åˆæœŸåŒ–ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ`);
            }
            */

        // UIä¸Šã®ãƒã‚¹ã‚³ãƒƒãƒˆåå‰ã‚’æ›´æ–°
        function updateMascotNameInUI(newName) {
          const titleElement = document.getElementById("mascot-name-title");
          const commentElement = document.getElementById("mascot-name-comment");

          if (titleElement) {
            titleElement.textContent = newName;
            console.log("âœ… ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ã®åå‰ã‚’æ›´æ–°:", newName);
          }

          if (commentElement) {
            commentElement.textContent = newName;
            console.log("âœ… ã‚³ãƒ¡ãƒ³ãƒˆéƒ¨åˆ†ã®åå‰ã‚’æ›´æ–°:", newName);
          }

          // MascotDisplayã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚‚åæ˜ 
          if (
            window.mascotDisplay &&
            typeof window.mascotDisplay.updateMascotName === "function"
          ) {
            window.mascotDisplay.updateMascotName(newName);
          }
        }

        // APIæ¥ç¶šãƒ†ã‚¹ãƒˆé–¢æ•°
        async function testApiConnection() {
          try {
            console.log("ğŸ” Laravel APIã‚µãƒ¼ãƒãƒ¼æ¥ç¶šç¢ºèª...");
            const healthResponse = await fetch(
              "http://localhost:8000/api/test",
              {
                method: "GET",
                headers: {
                  Accept: "application/json",
                },
              },
            );

            const healthStatus = {
              status: healthResponse.status,
              ok: healthResponse.ok,
              statusText: healthResponse.statusText,
            };

            // åŸºæœ¬APIæ¥ç¶šç¢ºèª
            console.log("ğŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ:", healthStatus);

            // ãƒã‚¹ã‚³ãƒƒãƒˆé–¢é€£APIç¢ºèª
            console.log("ğŸ¤– ãƒã‚¹ã‚³ãƒƒãƒˆAPIç¢ºèª...");
            const mascotResponse = await fetch(
              "http://localhost:8000/api/mascot/basic",
              {
                method: "GET",
                headers: {
                  Accept: "application/json",
                },
              },
            );

            const mascotStatus = {
              status: mascotResponse.status,
              ok: mascotResponse.ok,
              statusText: mascotResponse.statusText,
            };

            console.log("ğŸ¤– ãƒã‚¹ã‚³ãƒƒãƒˆAPIçµæœ:", mascotStatus);

            return {
              server_reachable: healthResponse.status !== 0,
              health_endpoint: healthStatus,
              mascot_endpoint: mascotStatus,
              overall_status:
                healthResponse.status !== 0 ? "connected" : "disconnected",
            };
          } catch (connectionError) {
            console.error("ğŸš« æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:", connectionError);
            return {
              server_reachable: false,
              error: connectionError.message,
              overall_status: "failed",
            };
          }
        }

        // ãƒ‡ãƒãƒƒã‚°ç”¨: APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆçŠ¶æ…‹ç¢ºèª
        function debugApiClientState() {
          console.log("ğŸ” === APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆçŠ¶æ…‹ç¢ºèª ===");
          console.log("window.apiClient:", window.apiClient);
          console.log("typeof window.apiClient:", typeof window.apiClient);

          if (window.apiClient) {
            console.log(
              "APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ©ç”¨å¯èƒ½ãƒ¡ã‚½ãƒƒãƒ‰:",
              Object.getOwnPropertyNames(window.apiClient),
            );
            console.log("updateMascotName:", window.apiClient.updateMascotName);
            console.log(
              "typeof updateMascotName:",
              typeof window.apiClient.updateMascotName,
            );
          } else {
            console.log("âŒ window.apiClientãŒå­˜åœ¨ã—ã¾ã›ã‚“");

            // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã®ç¢ºèª
            const apiScript = document.querySelector(
              'script[src*="apiClient.js"]',
            );
            console.log("apiClient.jsã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°:", apiScript);

            // å…¨ã¦ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ç¢ºèª
            const globals = Object.keys(window).filter((key) =>
              key.includes("api"),
            );
            console.log("APIé–¢é€£ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°:", globals);
          }
          console.log("===============================");
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆçŠ¶æ…‹ã‚’ç¢ºèª
        document.addEventListener("DOMContentLoaded", function () {
          setTimeout(() => {
            debugApiClientState();
          }, 2000); // 2ç§’å¾Œã«ãƒã‚§ãƒƒã‚¯
        });

        // å®‰å…¨ãªmascotPageé–¢æ•°å‘¼ã³å‡ºã—
        function safeCallMascot(methodName, ...args) {
          console.log(`ğŸ” ${methodName}ã‚’å‘¼ã³å‡ºã—ä¸­...`);

          // MascotDisplayã‚¯ãƒ©ã‚¹ã®ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã‚’å„ªå…ˆ
          if (
            window.mascotDisplay &&
            typeof window.mascotDisplay[methodName] === "function"
          ) {
            try {
              return window.mascotDisplay[methodName](...args);
            } catch (error) {
              console.error(`âŒ MascotDisplay.${methodName}ã‚¨ãƒ©ãƒ¼:`, error);
              alert(`${methodName}ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
          } else if (methodName === "feedMascot" && window.mascotDisplay) {
            // çµ¦é¤Œãƒœã‚¿ãƒ³ç”¨
            return window.mascotDisplay.handleFeedAction();
          } else if (methodName === "playWithMascot" && window.mascotDisplay) {
            // éŠã¶ãƒœã‚¿ãƒ³ç”¨
            return window.mascotDisplay.handlePlayAction();
          } else if (methodName === "petMascot" && window.mascotDisplay) {
            // ãªã§ã‚‹ãƒœã‚¿ãƒ³ç”¨
            return window.mascotDisplay.handlePetAction();
          } else if (
            window.mascotPage &&
            typeof window.mascotPage[methodName] === "function"
          ) {
            // å¾“æ¥ã®mascotPageãƒ¡ã‚½ãƒƒãƒ‰
            try {
              return window.mascotPage[methodName](...args);
            } catch (error) {
              console.error(`âŒ ${methodName}ã‚¨ãƒ©ãƒ¼:`, error);
              alert(`${methodName}ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
          } else {
            console.error(`âŒ ãƒ¡ã‚½ãƒƒãƒ‰${methodName}ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“`);
            console.log("åˆ©ç”¨å¯èƒ½ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ:", {
              mascotDisplay: !!window.mascotDisplay,
              mascotPage: !!window.mascotPage,
            });
            alert(
              "ãƒã‚¹ã‚³ãƒƒãƒˆæ©Ÿèƒ½ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚",
            );
          }
        }
      </script>
    </main>

    <!-- é€šçŸ¥ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- JavaScript -->
    <script src="js/utils/common.js?v=20260201-1720"></script>
    <script src="js/utils/apiClient.js?v=20260201-1720"></script>
    <script src="js/modules/weatherBackground.js?v=20260201-1720"></script>
    <script src="js/modules/mascotDisplay.js?v=20260201-1725"></script>
    <script src="js/modules/chatInterface.js?v=20260201-1720"></script>
    <script src="js/modules/missionManager.js?v=20260201-1720"></script>
    <script src="js/pages/mascotPage.js?v=20260201-1720"></script>

    <!-- åˆæœŸåŒ–ç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
      // è©³ç´°ãªåˆæœŸåŒ–ãƒ‡ãƒãƒƒã‚°
      let debugInfo = {
        startTime: new Date(),
        checks: [],
        dependencies: {},
        errors: [],
      };

      function logCheck(message) {
        const timestamp = new Date() - debugInfo.startTime;
        console.log(`[${timestamp}ms] ${message}`);
        debugInfo.checks.push({ timestamp, message });
      }

      function checkDependencies() {
        logCheck("ğŸ¯ ãƒŸãƒƒã‚·ãƒ§ãƒ³é–¢é€£ãƒã‚§ãƒƒã‚¯é–‹å§‹");

        // ãƒŸãƒƒã‚·ãƒ§ãƒ³é–¢é€£ã®è©³ç´°ãƒã‚§ãƒƒã‚¯
        logCheck("ğŸ” MissionManagerã‚¯ãƒ©ã‚¹å­˜åœ¨ç¢ºèª...");
        const missionManagerExists = typeof MissionManager !== "undefined";
        logCheck(
          `${missionManagerExists ? "âœ…" : "âŒ"} MissionManager: ${typeof MissionManager}`,
        );

        if (missionManagerExists) {
          logCheck("ğŸ” MissionManagerãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª...");
          const methods = Object.getOwnPropertyNames(MissionManager.prototype);
          logCheck(`ğŸ“‹ åˆ©ç”¨å¯èƒ½ãƒ¡ã‚½ãƒƒãƒ‰: ${methods.join(", ")}`);
        }

        // ãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤ºè¦ç´ ã®ç¢ºèª
        logCheck("ğŸ” ãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤ºDOMè¦ç´ ç¢ºèª...");
        const missionList = document.getElementById("mission-list");
        const missionContainer = document.getElementById("mission-container");
        logCheck(
          `${missionList ? "âœ…" : "âŒ"} mission-listè¦ç´ : ${!!missionList}`,
        );
        logCheck(
          `${missionContainer ? "âœ…" : "âŒ"} mission-containerè¦ç´ : ${!!missionContainer}`,
        );

        if (missionList) {
          logCheck(
            `ğŸ“ mission-listå†…å®¹: "${missionList.innerHTML.substring(0, 100)}..."`,
          );
        }

        // APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–¢é€£ã®ç¢ºèª
        logCheck("ğŸ” APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç¢ºèª...");
        const apiClientExists = typeof apiClient !== "undefined";
        logCheck(
          `${apiClientExists ? "âœ…" : "âŒ"} apiClient: ${typeof apiClient}`,
        );

        if (apiClientExists && apiClient.getTodayMissions) {
          logCheck("âœ… getTodayMissionsãƒ¡ã‚½ãƒƒãƒ‰åˆ©ç”¨å¯èƒ½");
        } else {
          logCheck("âŒ getTodayMissionsãƒ¡ã‚½ãƒƒãƒ‰æœªç¢ºèª");
        }

        logCheck("ğŸ” ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯é–‹å§‹");

        // å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å­˜åœ¨ç¢ºèª
        const dependencies = {
          window: typeof window !== "undefined",
          document: typeof document !== "undefined",
          MascotPage: typeof MascotPage !== "undefined",
          MissionManager: typeof MissionManager !== "undefined",
          apiClient:
            typeof apiClient !== "undefined" ||
            typeof window.apiClient !== "undefined",
          Storage: typeof Storage !== "undefined",
          formatTime: typeof formatTime !== "undefined",
        };

        debugInfo.dependencies = dependencies;

        for (const [name, exists] of Object.entries(dependencies)) {
          logCheck(`${exists ? "âœ…" : "âŒ"} ${name}: ${exists}`);
          if (!exists) {
            debugInfo.errors.push(`Missing dependency: ${name}`);
          }
        }

        return Object.values(dependencies).every(Boolean);
      }

      function attemptMascotPageCreation() {
        logCheck("ğŸš€ MascotPageä½œæˆè©¦è¡Œé–‹å§‹");

        try {
          if (typeof MascotPage === "undefined") {
            throw new Error("MascotPageã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“");
          }

          logCheck("ğŸ“ MascotPageã‚¯ãƒ©ã‚¹ç™ºè¦‹");

          const mascotPage = new MascotPage();
          logCheck("ğŸ—ï¸ MascotPageã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ");

          window.mascotPage = mascotPage;
          logCheck("ğŸŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°è¨­å®šå®Œäº†");

          // ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–çŠ¶æ³ç¢ºèª
          setTimeout(() => {
            logCheck("ğŸ¯ ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–çŠ¶æ³ç¢ºèª...");

            if (window.missionManager) {
              logCheck("âœ… window.missionManagerå­˜åœ¨ç¢ºèª");
              logCheck(
                `ğŸ“‹ ãƒŸãƒƒã‚·ãƒ§ãƒ³æ•°: ${window.missionManager.missions ? window.missionManager.missions.length : 0}`,
              );

              // ãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤ºçŠ¶æ³ç¢ºèª
              const missionListElement =
                document.getElementById("mission-list");
              if (missionListElement) {
                const content = missionListElement.innerHTML;
                if (content.includes("Laravelã‹ã‚‰ãƒŸãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ä¸­")) {
                  logCheck("ğŸ”„ ã¾ã ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­è¡¨ç¤º");
                } else if (content.includes("mission-item")) {
                  logCheck("âœ… ãƒŸãƒƒã‚·ãƒ§ãƒ³é …ç›®è¡¨ç¤ºæ¸ˆã¿");
                } else {
                  logCheck("â“ ä¸æ˜ãªãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤ºçŠ¶æ…‹");
                  logCheck(`ğŸ“ ç¾åœ¨ã®å†…å®¹: "${content.substring(0, 200)}..."`);
                }
              }
            } else {
              logCheck("âŒ window.missionManageræœªåˆæœŸåŒ–");
            }
          }, 1000); // 1ç§’å¾Œã«ãƒã‚§ãƒƒã‚¯

          return true;
        } catch (error) {
          logCheck(`âŒ MascotPageä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
          debugInfo.errors.push(`Creation error: ${error.message}`);
          console.error("MascotPageä½œæˆè©³ç´°ã‚¨ãƒ©ãƒ¼:", error);
          return false;
        }
      }

      // åˆæœŸåŒ–ã®çŠ¶æ…‹ã‚’å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯
      let initCheckCount = 0;
      const maxInitChecks = 15; // 7.5ç§’å¾…æ©Ÿ

      function checkMascotPageInitialization() {
        initCheckCount++;
        logCheck(`ğŸ”„ åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯ ${initCheckCount}/${maxInitChecks}`);

        if (window.mascotPage) {
          logCheck("âœ… mascotPageåˆæœŸåŒ–å®Œäº†ï¼");
          showSuccessStatus();
          return;
        }

        // 3å›ç›®ã¨6å›ç›®ã§ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
        if (initCheckCount === 3 || initCheckCount === 6) {
          if (!checkDependencies()) {
            logCheck("âš ï¸ ä¾å­˜é–¢ä¿‚ä¸è¶³ã®ãŸã‚ä½œæˆè©¦è¡Œã‚¹ã‚­ãƒƒãƒ—");
          } else {
            attemptMascotPageCreation();
          }
        }

        if (initCheckCount < maxInitChecks) {
          setTimeout(checkMascotPageInitialization, 500);
        } else {
          logCheck("âŒ åˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ");
          showErrorStatus();
          console.error("ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:", debugInfo);

          // è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
          const errorSummary = `
åˆæœŸåŒ–å¤±æ•—ã®è©³ç´°:
- ç·è©¦è¡Œæ™‚é–“: ${(new Date() - debugInfo.startTime) / 1000}ç§’
- ã‚¨ãƒ©ãƒ¼æ•°: ${debugInfo.errors.length}
- ä¸»ãªã‚¨ãƒ©ãƒ¼: ${debugInfo.errors.join(", ")}
- ä¾å­˜é–¢ä¿‚çŠ¶æ…‹: ${JSON.stringify(debugInfo.dependencies, null, 2)}
                `;
          console.error(errorSummary);
        }
      }

      function showSuccessStatus() {
        const statusDiv = document.createElement("div");
        statusDiv.id = "init-status";
        statusDiv.style.cssText =
          "position:fixed;top:10px;right:10px;background:green;color:white;padding:5px;border-radius:5px;z-index:9999;font-size:12px;";
        statusDiv.textContent = "âœ… åˆæœŸåŒ–å®Œäº†";
        document.body.appendChild(statusDiv);

        document.title = document.title + " âœ…";

        setTimeout(() => {
          if (statusDiv.parentNode) {
            statusDiv.parentNode.removeChild(statusDiv);
          }
        }, 5000);
      }

      function showErrorStatus() {
        const errorDiv = document.createElement("div");
        errorDiv.style.cssText =
          "position:fixed;top:10px;right:10px;background:red;color:white;padding:5px;border-radius:5px;z-index:9999;font-size:12px;cursor:pointer;";
        errorDiv.textContent = "âŒ åˆæœŸåŒ–å¤±æ•— (ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°)";
        errorDiv.onclick = () => {
          alert(`åˆæœŸåŒ–å¤±æ•—ã®è©³ç´°:\n${debugInfo.errors.join("\n")}`);
        };
        document.body.appendChild(errorDiv);

        document.title = document.title + " âŒ";
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒã‚§ãƒƒã‚¯é–‹å§‹
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
          logCheck("ğŸ“„ DOMèª­ã¿è¾¼ã¿å®Œäº†");
          // ã‚µãƒ¼ãƒãƒ¼ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®åå‰ã‚’åŒæœŸ
          syncMascotNameWithServer();
          setTimeout(() => {
            logCheck("â° åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯é–‹å§‹");
            checkMascotPageInitialization();
          }, 100);
        });
      } else {
        logCheck("ğŸ“„ DOMæ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿");
        // ã‚µãƒ¼ãƒãƒ¼ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®åå‰ã‚’åŒæœŸ
        syncMascotNameWithServer();
        setTimeout(() => {
          logCheck("â° åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯é–‹å§‹");
          checkMascotPageInitialization();
        }, 100);
      }

      // ã‚µãƒ¼ãƒãƒ¼ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®åå‰ã‚’åŒæœŸã™ã‚‹é–¢æ•°
      async function syncMascotNameWithServer() {
        try {
          console.log("ğŸ”„ ã‚µãƒ¼ãƒãƒ¼ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®åå‰åŒæœŸé–‹å§‹...");
          const response = await fetch(
            "http://localhost:8000/api/mascot/basic",
          );
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.data && data.data.name) {
              const serverName = data.data.name;
              console.log("ğŸŒ ã‚µãƒ¼ãƒãƒ¼ã®åå‰:", serverName);

              // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°
              localStorage.setItem("mascotName", serverName);
              if (typeof Storage !== "undefined" && Storage.set) {
                Storage.set("mascot-name", serverName);
              }
              console.log(
                "âœ… ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚µãƒ¼ãƒãƒ¼ã¨åŒæœŸå®Œäº†:",
                serverName,
              );
            }
          }
        } catch (error) {
          console.warn("âš ï¸ åå‰åŒæœŸã‚¨ãƒ©ãƒ¼:", error.message);
        }
      }
    </script>
  </body>
</html>
