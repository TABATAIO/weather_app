const axios = require('axios');

/**
 * Â§©Ê∞ó„Ç≥„Éº„Éâ„Åã„ÇâÂ§©Ê∞óÂêç„ÇíÂèñÂæó„Åô„Çã
 * @param {number} weatherCode - Â§©Ê∞ó„Ç≥„Éº„Éâ
 * @returns {string} Â§©Ê∞óÂêç
 */
function getWeatherName(weatherCode) {
  const weatherCodes = {
    100: 'Êô¥„Çå', 101: 'Êô¥„ÇåÊôÇ„ÄÖ„Åè„ÇÇ„Çä', 102: 'Êô¥„Çå‰∏ÄÊôÇÈõ®', 103: 'Êô¥„ÇåÊôÇ„ÄÖÈõ®',
    104: 'Êô¥„Çå‰∏ÄÊôÇÈõ™', 105: 'Êô¥„ÇåÊôÇ„ÄÖÈõ™', 106: 'Êô¥„Çå‰∏ÄÊôÇÈõ®„ÅãÈõ™', 107: 'Êô¥„ÇåÊôÇ„ÄÖÈõ®„ÅãÈõ™',
    108: 'Êô¥„Çå‰∏ÄÊôÇÈõ®„ÅãÈõ∑Èõ®', 110: 'Êô¥„Çå„ÅÆ„Å°ÊôÇ„ÄÖ„Åè„ÇÇ„Çä', 111: 'Êô¥„Çå„ÅÆ„Å°„Åè„ÇÇ„Çä', 112: 'Êô¥„Çå„ÅÆ„Å°‰∏ÄÊôÇÈõ®',
    113: 'Êô¥„Çå„ÅÆ„Å°ÊôÇ„ÄÖÈõ®', 114: 'Êô¥„Çå„ÅÆ„Å°Èõ®', 115: 'Êô¥„Çå„ÅÆ„Å°‰∏ÄÊôÇÈõ™', 116: 'Êô¥„Çå„ÅÆ„Å°ÊôÇ„ÄÖÈõ™',
    117: 'Êô¥„Çå„ÅÆ„Å°Èõ™', 118: 'Êô¥„Çå„ÅÆ„Å°Èõ®„ÅãÈõ™', 119: 'Êô¥„Çå„ÅÆ„Å°Èõ®„ÅãÈõ∑Èõ®', 120: 'Êô¥„ÇåÊúùÂ§ï‰∏ÄÊôÇÈõ®',
    121: 'Êô¥„ÇåÊúù„ÅÆÂÜÖ‰∏ÄÊôÇÈõ®', 122: 'Êô¥„ÇåÂ§ïÊñπ‰∏ÄÊôÇÈõ®', 123: 'Êô¥„ÇåÂ±±Ê≤ø„ÅÑÈõ∑Èõ®', 124: 'Êô¥„ÇåÂ±±Ê≤ø„ÅÑÈõ™',
    125: 'Êô¥„ÇåÂçàÂæå„ÅØÈõ∑Èõ®', 126: 'Êô¥„ÇåÊòºÈ†É„Åã„ÇâÈõ®', 127: 'Êô¥„ÇåÂ§ïÊñπ„Åã„ÇâÈõ®', 128: 'Êô¥„ÇåÂ§ú„ÅØÈõ®',
    129: 'Êô¥„ÇåÂ§úÂçä„Åã„ÇâÈõ®', 130: 'Êúù„ÅÆÂÜÖÈúß„ÅÆ„Å°Êô¥„Çå', 131: 'Êô¥„ÇåÊúùÊñπÈúß', 132: 'Êô¥„ÇåÊúùÂ§ï„Åè„ÇÇ„Çä',
    140: 'Êô¥„ÇåÊôÇ„ÄÖÈõ®„ÅßÈõ∑„Çí‰º¥„ÅÜ', 160: 'Êô¥„Çå‰∏ÄÊôÇÈõ™„ÅãÈõ®', 170: 'Êô¥„ÇåÊôÇ„ÄÖÈõ™„ÅãÈõ®', 181: 'Êô¥„Çå„ÅÆ„Å°Èõ™„ÅãÈõ®',
    
    200: '„Åè„ÇÇ„Çä', 201: '„Åè„ÇÇ„ÇäÊôÇ„ÄÖÊô¥„Çå', 202: '„Åè„ÇÇ„Çä‰∏ÄÊôÇÈõ®', 203: '„Åè„ÇÇ„ÇäÊôÇ„ÄÖÈõ®',
    204: '„Åè„ÇÇ„Çä‰∏ÄÊôÇÈõ™', 205: '„Åè„ÇÇ„ÇäÊôÇ„ÄÖÈõ™', 206: '„Åè„ÇÇ„Çä‰∏ÄÊôÇÈõ®„ÅãÈõ™', 207: '„Åè„ÇÇ„ÇäÊôÇ„ÄÖÈõ®„ÅãÈõ™',
    208: '„Åè„ÇÇ„Çä‰∏ÄÊôÇÈõ®„ÅãÈõ∑Èõ®', 209: 'Èúß', 210: '„Åè„ÇÇ„Çä„ÅÆ„Å°ÊôÇ„ÄÖÊô¥„Çå', 211: '„Åè„ÇÇ„Çä„ÅÆ„Å°Êô¥„Çå',
    212: '„Åè„ÇÇ„Çä„ÅÆ„Å°‰∏ÄÊôÇÈõ®', 213: '„Åè„ÇÇ„Çä„ÅÆ„Å°ÊôÇ„ÄÖÈõ®', 214: '„Åè„ÇÇ„Çä„ÅÆ„Å°Èõ®', 215: '„Åè„ÇÇ„Çä„ÅÆ„Å°‰∏ÄÊôÇÈõ™',
    216: '„Åè„ÇÇ„Çä„ÅÆ„Å°ÊôÇ„ÄÖÈõ™', 217: '„Åè„ÇÇ„Çä„ÅÆ„Å°Èõ™', 218: '„Åè„ÇÇ„Çä„ÅÆ„Å°Èõ®„ÅãÈõ™', 219: '„Åè„ÇÇ„Çä„ÅÆ„Å°Èõ®„ÅãÈõ∑Èõ®',
    220: '„Åè„ÇÇ„ÇäÊúùÂ§ï‰∏ÄÊôÇÈõ®', 221: '„Åè„ÇÇ„ÇäÊúù„ÅÆÂÜÖ‰∏ÄÊôÇÈõ®', 222: '„Åè„ÇÇ„ÇäÂ§ïÊñπ‰∏ÄÊôÇÈõ®', 223: '„Åè„ÇÇ„ÇäÊó•‰∏≠ÊôÇ„ÄÖÊô¥„Çå',
    224: '„Åè„ÇÇ„ÇäÊòºÈ†É„Åã„ÇâÈõ®', 225: '„Åè„ÇÇ„ÇäÂ§ïÊñπ„Åã„ÇâÈõ®', 226: '„Åè„ÇÇ„ÇäÂ§ú„ÅØÈõ®', 227: '„Åè„ÇÇ„ÇäÂ§úÂçä„Åã„ÇâÈõ®',
    228: '„Åè„ÇÇ„ÇäÊòºÈ†É„Åã„ÇâÈõ™', 229: '„Åè„ÇÇ„ÇäÂ§ïÊñπ„Åã„ÇâÈõ™', 230: '„Åè„ÇÇ„ÇäÂ§ú„ÅØÈõ™', 231: '„Åè„ÇÇ„ÇäÊµ∑‰∏äÊµ∑Â≤∏„ÅØÈúß„ÅãÈúßÈõ®',
    240: '„Åè„ÇÇ„ÇäÊôÇ„ÄÖÈõ®„ÅßÈõ∑„Çí‰º¥„ÅÜ', 250: '„Åè„ÇÇ„ÇäÊôÇ„ÄÖÈõ™„ÅßÈõ∑„Çí‰º¥„ÅÜ', 260: '„Åè„ÇÇ„Çä‰∏ÄÊôÇÈõ™„ÅãÈõ®', 270: '„Åè„ÇÇ„ÇäÊôÇ„ÄÖÈõ™„ÅãÈõ®',
    281: '„Åè„ÇÇ„Çä„ÅÆ„Å°Èõ™„ÅãÈõ®',
    
    300: 'Èõ®', 301: 'Èõ®ÊôÇ„ÄÖÊô¥„Çå', 302: 'Èõ®ÊôÇ„ÄÖÊ≠¢„ÇÄ', 303: 'Èõ®ÊôÇ„ÄÖÈõ™', 304: 'Èõ®„ÅãÈõ™',
    306: 'Â§ßÈõ®', 308: 'Èõ®„ÅßÊö¥È¢®„Çí‰º¥„ÅÜ', 309: 'Èõ®‰∏ÄÊôÇÈõ™', 311: 'Èõ®„ÅÆ„Å°Êô¥„Çå', 313: 'Èõ®„ÅÆ„Å°„Åè„ÇÇ„Çä',
    314: 'Èõ®„ÅÆ„Å°ÊôÇ„ÄÖÈõ™', 315: 'Èõ®„ÅÆ„Å°Èõ™', 316: 'Èõ®„ÅãÈõ™„ÅÆ„Å°Êô¥„Çå', 317: 'Èõ®„ÅãÈõ™„ÅÆ„Å°„Åè„ÇÇ„Çä',
    320: 'Êúù„ÅÆÂÜÖÈõ®„ÅÆ„Å°Êô¥„Çå', 321: 'Êúù„ÅÆÂÜÖÈõ®„ÅÆ„Å°„Åè„ÇÇ„Çä', 322: 'Èõ®ÊúùÊô©‰∏ÄÊôÇÈõ™', 323: 'Èõ®ÊòºÈ†É„Åã„ÇâÊô¥„Çå',
    324: 'Èõ®Â§ïÊñπ„Åã„ÇâÊô¥„Çå', 325: 'Èõ®Â§ú„ÅØÊô¥„Çå', 326: 'Èõ®Â§ïÊñπ„Åã„ÇâÈõ™', 327: 'Èõ®Â§ú„ÅØÈõ™',
    328: 'Èõ®‰∏ÄÊôÇÂº∑„ÅèÈôç„Çã', 329: 'Èõ®‰∏ÄÊôÇ„Åø„Åû„Çå', 340: 'Èõ™„ÅãÈõ®', 350: 'Èõ®„ÅßÈõ∑„Çí‰º¥„ÅÜ',
    361: 'Èõ™„ÅãÈõ®„ÅÆ„Å°Êô¥„Çå', 371: 'Èõ™„ÅãÈõ®„ÅÆ„Å°„Åè„ÇÇ„Çä',
    
    400: 'Èõ™', 401: 'Èõ™ÊôÇ„ÄÖÊô¥„Çå', 402: 'Èõ™ÊôÇ„ÄÖÊ≠¢„ÇÄ', 403: 'Èõ™ÊôÇ„ÄÖÈõ®', 405: 'Â§ßÈõ™',
    406: 'È¢®Èõ™Âº∑„ÅÑ', 407: 'Êö¥È¢®Èõ™', 409: 'Èõ™‰∏ÄÊôÇÈõ®', 411: 'Èõ™„ÅÆ„Å°Êô¥„Çå', 413: 'Èõ™„ÅÆ„Å°„Åè„ÇÇ„Çä',
    414: 'Èõ™„ÅÆ„Å°Èõ®', 420: 'Êúù„ÅÆÂÜÖÈõ™„ÅÆ„Å°Êô¥„Çå', 421: 'Êúù„ÅÆÂÜÖÈõ™„ÅÆ„Å°„Åè„ÇÇ„Çä', 422: 'Èõ™ÊòºÈ†É„Åã„ÇâÈõ®',
    423: 'Èõ™Â§ïÊñπ„Åã„ÇâÈõ®', 424: 'Èõ™Â§úÂçä„Åã„ÇâÈõ®', 425: 'Èõ™‰∏ÄÊôÇÂº∑„ÅèÈôç„Çã', 426: 'Èõ™„ÅÆ„Å°„Åø„Åû„Çå',
    427: 'Èõ™‰∏ÄÊôÇ„Åø„Åû„Çå', 430: '„Åø„Åû„Çå', 450: 'Èõ™„ÅßÈõ∑„Çí‰º¥„ÅÜ',
    
    500: 'Âø´Êô¥', 550: 'ÁåõÊöë', 552: 'ÁåõÊöëÊôÇ„ÄÖÊõá„Çä', 553: 'ÁåõÊöëÊôÇ„ÄÖÈõ®', 558: 'ÁåõÊöëÊôÇ„ÄÖÂ§ßÈõ®„ÉªÂµê',
    562: 'ÁåõÊöë„ÅÆ„Å°Êõá„Çä', 563: 'ÁåõÊöë„ÅÆ„Å°Èõ®', 568: 'ÁåõÊöë„ÅÆ„Å°Â§ßÈõ®„ÉªÂµê', 572: 'Êõá„ÇäÊôÇ„ÄÖÁåõÊöë',
    573: 'Èõ®ÊôÇ„ÄÖÁåõÊöë', 582: 'Êõá„Çä„ÅÆ„Å°ÁåõÊöë', 583: 'Èõ®„ÅÆ„Å°ÁåõÊöë',
    
    600: '„ÅÜ„Åô„Åê„ÇÇ„Çä', 650: 'Â∞èÈõ®', 800: 'Èõ∑', 850: 'Â§ßÈõ®„ÉªÂµê', 851: 'Â§ßÈõ®„ÉªÂµêÊôÇ„ÄÖÊô¥„Çå',
    852: 'Â§ßÈõ®„ÉªÂµêÊôÇ„ÄÖÊõá„Çä', 853: 'Â§ßÈõ®„ÉªÂµêÊôÇ„ÄÖÈõ®', 854: 'Â§ßÈõ®„ÉªÂµêÊôÇ„ÄÖÈõ™', 855: 'Â§ßÈõ®„ÉªÂµêÊôÇ„ÄÖÁåõÊöë',
    859: 'Â§ßÈõ®„ÉªÂµê‰∏ÄÊôÇÂ§ßÈõ™', 861: 'Â§ßÈõ®„ÉªÂµê„ÅÆ„Å°Êô¥„Çå', 862: 'Â§ßÈõ®„ÉªÂµê„ÅÆ„Å°Êõá„Çä', 863: 'Â§ßÈõ®„ÉªÂµê„ÅÆ„Å°Èõ®',
    864: 'Â§ßÈõ®„ÉªÂµê„ÅÆ„Å°Èõ™', 865: 'Â§ßÈõ®„ÉªÂµê„ÅÆ„Å°ÁåõÊöë', 869: 'Â§ßÈõ®„ÉªÂµê„ÅÆ„Å°Â§ßÈõ™', 871: 'Êô¥„ÇåÊôÇ„ÄÖÂ§ßÈõ®„ÉªÂµê',
    872: 'Êõá„ÇäÊôÇ„ÄÖÂ§ßÈõ®„ÉªÂµê', 873: 'Èõ®ÊôÇ„ÄÖÂ§ßÈõ®„ÉªÂµê', 874: 'Èõ™ÊôÇ„ÄÖÂ§ßÈõ®„ÉªÂµê', 881: 'Êô¥„Çå„ÅÆ„Å°Â§ßÈõ®„ÉªÂµê',
    882: 'Êõá„Çä„ÅÆ„Å°Â§ßÈõ®„ÉªÂµê', 883: 'Èõ®„ÅÆ„Å°Â§ßÈõ®„ÉªÂµê', 884: 'Èõ™„ÅÆ„Å°Â§ßÈõ®„ÉªÂµê',
    
    950: 'Â§ßÈõ™', 951: 'Â§ßÈõ™ÊôÇ„ÄÖÊô¥„Çå', 952: 'Â§ßÈõ™ÊôÇ„ÄÖÊõá', 953: 'Â§ßÈõ™‰∏ÄÊôÇÈõ®', 954: 'Â§ßÈõ™ÊôÇ„ÄÖÈõ™',
    958: 'Â§ßÈõ™‰∏ÄÊôÇÂ§ßÈõ®', 961: 'Â§ßÈõ™„ÅÆ„Å°Êô¥„Çå', 962: 'Â§ßÈõ™„ÅÆ„Å°Êõá', 963: 'Â§ßÈõ™„ÅÆ„Å°Èõ®',
    964: 'Â§ßÈõ™„ÅÆ„Å°Èõ™', 968: 'Â§ßÈõ™„ÅÆ„Å°Â§ßÈõ®„ÉªÂµê', 971: 'Êô¥„Çå‰∏ÄÊôÇÂ§ßÈõ™', 972: 'Êõá‰∏ÄÊôÇÂ§ßÈõ™',
    973: 'Èõ®‰∏ÄÊôÇÂ§ßÈõ™', 974: 'Èõ™‰∏ÄÊôÇÂ§ßÈõ™', 981: 'Êô¥„Çå„ÅÆ„Å°Â§ßÈõ™', 982: 'Êõá„ÅÆ„Å°Â§ßÈõ™',
    983: 'Èõ®„ÅÆ„Å°Â§ßÈõ™', 984: 'Èõ™„ÅÆ„Å°Â§ßÈõ™', 999: '„Éá„Éº„Çø„Å™„Åó'
  };
  
  return weatherCodes[weatherCode] || `Â§©Ê∞ó„Ç≥„Éº„Éâ${weatherCode}`;
}

/**
 * Â§©Ê∞ó„Ç¢„Ç§„Ç≥„É≥URLÁîüÊàêÈñ¢Êï∞
 * @param {number} weatherCode - Â§©Ê∞ó„Ç≥„Éº„Éâ
 * @returns {string} „Ç¢„Ç§„Ç≥„É≥URL
 */
function getWeatherIcon(weatherCode) {
  return `https://tpf.weathernews.jp/wxicon/152/${weatherCode}.png`;
}

/**
 * È¢®ÂêëÂ§âÊèõÈñ¢Êï∞
 * @param {number} windDirectionCode - È¢®Âêë„Ç≥„Éº„Éâ
 * @returns {string} È¢®ÂêëÂêç
 */
function getWindDirection(windDirectionCode) {
  const windDirections = {
    1: 'NNE', 2: 'NE', 3: 'ENE', 4: 'E', 5: 'ESE', 6: 'SE', 7: 'SSE', 8: 'S',
    9: 'SSW', 10: 'SW', 11: 'WSW', 12: 'W', 13: 'WNW', 14: 'NW', 15: 'NNW', 16: 'N'
  };
  
  return windDirections[windDirectionCode] || '‰∏çÊòé';
}

/**
 * Â§©Ê∞ó„Ç≥„Éº„Éâ„Åã„Çâ„Ç´„ÉÜ„Ç¥„É™„Éº„ÇíÂèñÂæó
 * @param {number} weatherCode - Â§©Ê∞ó„Ç≥„Éº„Éâ
 * @returns {string} Â§©Ê∞ó„Ç´„ÉÜ„Ç¥„É™„Éº
 */
function getWeatherCategory(weatherCode) {
  if (weatherCode >= 100 && weatherCode < 200) {
    return 'sunny'; // Êô¥„ÇåÁ≥ª
  } else if (weatherCode >= 200 && weatherCode < 300) {
    return 'cloudy'; // Êõá„ÇäÁ≥ª
  } else if (weatherCode >= 300 && weatherCode < 400) {
    return 'rainy'; // Èõ®Á≥ª
  } else if (weatherCode >= 400 && weatherCode < 500) {
    return 'snowy'; // Èõ™Á≥ª
  } else if (weatherCode >= 500 && weatherCode < 600) {
    return 'foggy'; // ÈúßÁ≥ª
  } else if (weatherCode >= 600 && weatherCode < 700) {
    return 'clear_night'; // Â§úÈñìÊô¥„ÇåÁ≥ª
  } else if (weatherCode >= 700 && weatherCode < 800) {
    return 'cloudy_night'; // Â§úÈñìÊõá„ÇäÁ≥ª
  } else if (weatherCode >= 800 && weatherCode < 900) {
    return 'storm'; // Âµê„ÉªÂº∑È¢®Á≥ª
  } else if (weatherCode >= 900 && weatherCode < 1000) {
    return 'severe'; // Ë≠¶Â†±„ÉªÊ≥®ÊÑèÂ†±Á≥ª
  } else {
    return 'unknown';
  }
}

/**
 * ÈÉΩÂ∏ÇÂêç„Åã„ÇâÁ∑ØÂ∫¶ÁµåÂ∫¶„ÇíÂèñÂæó„Åô„Çã
 * @param {string} cityName - ÈÉΩÂ∏ÇÂêç
 * @returns {Object} Á∑ØÂ∫¶ÁµåÂ∫¶ÊÉÖÂ†±
 */
function getCityCoordinates(cityName) {
  const cityCoords = {
    'tokyo': { lat: 35.6762, lon: 139.6503, name: 'Êù±‰∫¨', fullName: 'Êù±‰∫¨ÈÉΩÂçÉ‰ª£Áî∞Âå∫' },
    'osaka': { lat: 34.6937, lon: 135.5023, name: 'Â§ßÈò™', fullName: 'Â§ßÈò™Â∫úÂ§ßÈò™Â∏Ç' },
    'kyoto': { lat: 35.0116, lon: 135.7681, name: '‰∫¨ÈÉΩ', fullName: '‰∫¨ÈÉΩÂ∫ú‰∫¨ÈÉΩÂ∏Ç' },
    'yokohama': { lat: 35.4478, lon: 139.6425, name: 'Ê®™Êµú', fullName: 'Á•ûÂ•àÂ∑ùÁúåÊ®™ÊµúÂ∏Ç' },
    'nagoya': { lat: 35.1815, lon: 136.9066, name: 'ÂêçÂè§Â±ã', fullName: 'ÊÑõÁü•ÁúåÂêçÂè§Â±ãÂ∏Ç' },
    'fukuoka': { lat: 33.5904, lon: 130.4017, name: 'Á¶èÂ≤°', fullName: 'Á¶èÂ≤°ÁúåÁ¶èÂ≤°Â∏Ç' },
    'sendai': { lat: 38.2682, lon: 140.8694, name: '‰ªôÂè∞', fullName: 'ÂÆÆÂüéÁúå‰ªôÂè∞Â∏Ç' },
    'hiroshima': { lat: 34.3853, lon: 132.4553, name: 'Â∫ÉÂ≥∂', fullName: 'Â∫ÉÂ≥∂ÁúåÂ∫ÉÂ≥∂Â∏Ç' }
  };
  
  return cityCoords[cityName.toLowerCase()];
}

/**
 * Weathernews API„Åã„ÇâÂ§©Ê∞ó„Éá„Éº„Çø„ÇíÂèñÂæó„Åô„Çã
 * @param {number} lat - Á∑ØÂ∫¶
 * @param {number} lon - ÁµåÂ∫¶
 * @returns {Object} Â§©Ê∞ó„Éá„Éº„Çø
 */
async function fetchWeatherData(lat, lon) {
  const apiUrl = `https://wxtech.weathernews.com/wxdata/1km_v2.cgi?zoom=12&layout=json&lat=${lat}&lon=${lon}`;
  
  console.log(`üå§Ô∏è Weathernews APIÂëº„Å≥Âá∫„Åó: ${apiUrl}`);
  
  const response = await axios.get(apiUrl, {
    timeout: 10000,
    headers: {
      'User-Agent': 'WeatherApp/1.0'
    }
  });
  
  const wxdata = response.data;
  console.log('‚úÖ Weathernews API„É¨„Çπ„Éù„É≥„ÇπÂèñÂæóÂÆå‰∫Ü');
  
  // „É¨„Çπ„Éù„É≥„ÇπÊßãÈÄ†„ÅÆÁ¢∫Ë™ç
  if (!wxdata || !wxdata.srf || !Array.isArray(wxdata.srf)) {
    throw new Error('Weathernews API„É¨„Çπ„Éù„É≥„Çπ„ÅÆÊßãÈÄ†„Åå‰∫àÊúü„Åó„Å™„ÅÑÂΩ¢Âºè„Åß„Åô');
  }
  
  // ÁèæÂú®„ÅÆ‰∫àÂ†±„Éá„Éº„Çø„ÇíÂèñÂæóÔºàÊúÄÂàù„ÅÆË¶ÅÁ¥†Ôºâ
  const currentForecast = wxdata.srf[0];
  if (!currentForecast) {
    throw new Error('ÁèæÂú®„ÅÆÂ§©Ê∞ó„Éá„Éº„Çø„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì');
  }
  
  // È¢®Âêë„Åç„ÇíÂêçÂâç„Å´Â§âÊèõ
  const windDirectionName = getWindDirection(currentForecast.wnddir);
  
  // Â§©Ê∞ó„Ç¢„Ç§„Ç≥„É≥„Å®„Ç´„ÉÜ„Ç¥„É™„Éº„ÇíÂèñÂæó
  const weatherIcon = getWeatherIcon(currentForecast.wx);
  const weatherCategory = getWeatherCategory(currentForecast.wx);
  const weatherName = getWeatherName(currentForecast.wx);
  
  // ‰ªäÊó•„ÅÆ‰∏≠Êúü‰∫àÂ†±„Éá„Éº„Çø„ÇíÊ§úÁ¥¢
  let todayMediumForecast = null;
  if (wxdata.mrf && Array.isArray(wxdata.mrf)) {
    const today = new Date().toISOString().split('T')[0];
    todayMediumForecast = wxdata.mrf.find(forecast => 
      forecast.date && forecast.date.startsWith(today)
    );
  }
  
  // „É¨„Çπ„Éù„É≥„Çπ„Éá„Éº„Çø„ÇíÊßãÁØâ
  const weatherData = {
    location: { lat, lon },
    current: {
      weatherCode: currentForecast.wx,
      weather: weatherName,
      category: weatherCategory,
      temperature: currentForecast.tmpc,
      feelsLike: currentForecast.fltmpc,
      humidity: currentForecast.rhum,
      precipitation: currentForecast.prec,
      windSpeed: currentForecast.wndspd,
      windDirection: windDirectionName,
      windDirectionCode: currentForecast.wnddir,
      pressure: currentForecast.arpress,
      icon: weatherIcon
    },
    today: {
      date: todayMediumForecast?.date,
      maxTemp: todayMediumForecast?.maxtemp,
      minTemp: todayMediumForecast?.mintemp,
      precipitationProbability: todayMediumForecast?.pop,
      weatherCode: todayMediumForecast?.wx
    },
    forecast: {
      shortTerm: wxdata.srf.slice(0, 24), // 24ÊôÇÈñìÂàÜ
      mediumTerm: wxdata.mrf.slice(0, 7)  // 7Êó•ÂàÜ
    },
    timestamp: new Date().toISOString()
  };
  
  return weatherData;
}

module.exports = {
  getWeatherName,
  getWeatherIcon,
  getWindDirection,
  getWeatherCategory,
  getCityCoordinates,
  fetchWeatherData
};