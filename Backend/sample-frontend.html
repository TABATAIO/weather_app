<!-- ----------------------------------------------------------------------------
ãƒ©ã‚¤ãƒ–ã‚µãƒ¼ãƒãƒ¼ã§ã®èµ·å‹•æ™‚æ³¨æ„äº‹é …
èµ·å‹•ã™ã‚‹ã¨è‡ªå‹•ã§ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ãã¾ã™ãŒã€ä»•æ§˜ä¸Šä½•åº¦ã‚‚ãƒªãƒ­ãƒ¼ãƒ‰ãŒèµ·ã“ã£ã¦ã—ã¾ã†ãŸã‚ã€
ï¼‘ã€ã¾ãšä¸€å›èµ·å‹•ã—ãŸã®ã¡ã‚µãƒ¼ãƒãƒ¼ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚ï¼ˆã“ã®æ™‚è‡ªå‹•ã§é–‹ã„ãŸãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ãƒ–ã¯æ®‹ã—ã¦ãŠã„ã¦ãã ã•ã„ï¼‰
ï¼’ã€å†åº¦ãƒ©ã‚¤ãƒ–ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ï¼ˆã“ã®æ™‚è‡ªå‹•ã§é–‹ã„ãŸæ–°ãŸãªã‚¿ãƒ–ã¯é–‰ã˜ã¦ãã ã•ã„ï¼‰
ï¼“ã€æœ€åˆã«é–‹ã„ãŸã‚¿ãƒ–ã§æ“ä½œã—ã¦ãã ã•ã„ã€‚
---------------------------------------------------------------------------- -->

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©æ°—ãƒã‚¹ã‚³ãƒƒãƒˆ - ã‚µãƒ³ãƒ—ãƒ«ç”»é¢</title>
    <style>
        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #87CEEB, #98FB98);
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .weather-card {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        #weather-icon {
            width: 152px;
            height: 112px;
            margin: 10px auto;
            display: block;
        }
        
        .temperature {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        
        .weather-name {
            font-size: 1.5em;
            color: #666;
            margin: 5px 0;
        }
        
        .temp-range {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 10px 0;
            color: #888;
        }
        
        .mascot-section {
            margin: 20px 0;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border: 2px solid #ffeaa7;
        }
        
        .mascot-mood {
            font-size: 1.3em;
            font-weight: bold;
            color: #e17055;
            margin: 10px 0;
        }
        
        .energy-container {
            margin: 15px 0;
        }
        
        .energy-bar-bg {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .energy-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff7675, #fd79a8, #fdcb6e);
            border-radius: 10px;
            transition: width 0.8s ease;
            width: 0%;
        }
        
        .weather-reaction {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
            margin: 15px 0;
            font-style: italic;
        }
        
        .recommendations {
            background: #d4edda;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .recommendations ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .recommendations li {
            margin: 5px 0;
        }
        
        .chat-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .chat-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .chat-input button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .chat-input button:hover {
            background: #0056b3;
        }
        
        .chat-response {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            min-height: 50px;
        }
        
        .loading {
            color: #888;
            font-style: italic;
        }
        
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .city-selector {
            margin: 20px 0;
            text-align: center;
        }
        
        .city-selector select {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .forecast-section {
            margin: 20px 0;
        }
        
        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .forecast-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .forecast-time {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .forecast-temp {
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ¤ï¸ å¤©æ°—ãƒã‚¹ã‚³ãƒƒãƒˆ</h1>
        
        <!-- éƒ½å¸‚é¸æŠ -->
        <div class="city-selector">
            <label for="city-select">éƒ½å¸‚ã‚’é¸æŠ:</label>
            <select id="city-select" onchange="changeCity()">
                <option value="tokyo">æ±äº¬</option>
                <option value="osaka">å¤§é˜ª</option>
                <option value="kyoto">äº¬éƒ½</option>
                <option value="yokohama">æ¨ªæµœ</option>
                <option value="nagoya">åå¤å±‹</option>
                <option value="fukuoka">ç¦å²¡</option>
                <option value="sendai">ä»™å°</option>
                <option value="hiroshima">åºƒå³¶</option>
                <option value="sapporo">æœ­å¹Œ</option>
                <option value="naha">é‚£è¦‡</option>
            </select>
        </div>
        
        <!-- å¤©æ°—æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="weather-card">
            <img id="weather-icon" src="" alt="å¤©æ°—ã‚¢ã‚¤ã‚³ãƒ³" style="display: none;">
            <div id="temperature" class="temperature">--Â°C</div>
            <div id="weather-name" class="weather-name">å¤©æ°—æƒ…å ±ã‚’å–å¾—ä¸­...</div>
            <div class="temp-range">
                <span id="max-temp">æœ€é«˜: --Â°C</span>
                <span id="min-temp">æœ€ä½: --Â°C</span>
            </div>
        </div>
        
        <!-- ãƒã‚¹ã‚³ãƒƒãƒˆçŠ¶æ…‹è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="mascot-section">
            <h3>ğŸ­ ãƒã‚¹ã‚³ãƒƒãƒˆã®çŠ¶æ…‹</h3>
            <div id="mascot-mood" class="mascot-mood">æ°—åˆ†: --</div>
            
            <div class="energy-container">
                <div>ã‚¨ãƒãƒ«ã‚®ãƒ¼:</div>
                <div class="energy-bar-bg">
                    <div id="energy-bar" class="energy-bar"></div>
                </div>
            </div>
            
            <div id="weather-reaction" class="weather-reaction">
                å¤©æ°—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—ä¸­...
            </div>
            
            <div class="recommendations">
                <h4>ğŸ“ ä»Šæ—¥ã®ãŠã™ã™ã‚</h4>
                <ul id="recommendations">
                    <li>ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</li>
                </ul>
            </div>
        </div>
        
        <!-- AIä¼šè©±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="chat-section">
            <h3>ğŸ’¬ ãƒã‚¹ã‚³ãƒƒãƒˆã¨ã®ä¼šè©±</h3>
            <div class="chat-input">
                <input type="text" id="chat-input" placeholder="ãƒã‚¹ã‚³ãƒƒãƒˆã«è©±ã—ã‹ã‘ã¦ã¿ã¾ã—ã‚‡ã†..." />
                <button onclick="sendChatMessage()">é€ä¿¡</button>
            </div>
            <div id="chat-response" class="chat-response">
                ãƒã‚¹ã‚³ãƒƒãƒˆãŒã‚ãªãŸã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾…ã£ã¦ã„ã¾ã™...
            </div>
        </div>
        
        <!-- äºˆå ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="forecast-section">
            <h3>ğŸ”® 24æ™‚é–“äºˆå ±</h3>
            <div id="forecast-grid" class="forecast-grid">
                <!-- äºˆå ±ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <script>
        // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
        let currentWeatherData = null;
        let currentMascotState = null;
        let isLoading = false;
        let loadingTimeout = null;
        let isInitialized = false;
        
        // APIé–¢æ•°ç¾¤ï¼ˆfrontend-sample.jsã‹ã‚‰ï¼‰
        async function getWeatherByCity(city) {
            try {
                const response = await fetch(`http://localhost:3001/api/weather/city/${city}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return data.data;
                } else {
                    console.error('å¤©æ°—å–å¾—ã‚¨ãƒ©ãƒ¼:', data.error);
                    showError('å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                    return null;
                }
            } catch (error) {
                console.error('APIé€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                showError('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                return null;
            }
        }
        
        async function updateMascotState(weatherData) {
            try {
                const response = await fetch('http://localhost:3001/api/mascot/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        weatherCode: weatherData.current.weatherCode,
                        temperature: weatherData.current.temperature,
                        humidity: weatherData.current.humidity,
                        precipitation: weatherData.current.precipitation,
                        windSpeed: weatherData.current.windSpeed,
                        pressure: weatherData.current.pressure
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return data.data;
                } else {
                    console.error('ãƒã‚¹ã‚³ãƒƒãƒˆçŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', data.error);
                    return null;
                }
            } catch (error) {
                console.error('APIé€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }
        
        async function chatWithMascot(message, userName, weatherData = null) {
            try {
                const response = await fetch('http://localhost:3001/api/mascot/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        userName: userName,
                        weatherData: weatherData,
                        userId: `user_${Date.now()}`
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return data.data;
                } else {
                    console.error('AIä¼šè©±ã‚¨ãƒ©ãƒ¼:', data.error);
                    return null;
                }
            } catch (error) {
                console.error('APIé€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }
        
        // UIæ›´æ–°é–¢æ•°
        function displayWeatherData(weatherData) {
            const weatherIcon = document.getElementById('weather-icon');
            if (weatherIcon && weatherData.current.icon) {
                weatherIcon.src = weatherData.current.icon;
                weatherIcon.alt = weatherData.current.weather;
                weatherIcon.style.display = 'block';
            }
            
            const temperature = document.getElementById('temperature');
            if (temperature) {
                temperature.textContent = `${weatherData.current.temperature}Â°C`;
            }
            
            const weatherName = document.getElementById('weather-name');
            if (weatherName) {
                weatherName.textContent = weatherData.current.weather;
            }
            
            const maxTemp = document.getElementById('max-temp');
            const minTemp = document.getElementById('min-temp');
            if (maxTemp && weatherData.today.maxTemp !== -9999) {
                maxTemp.textContent = `æœ€é«˜: ${weatherData.today.maxTemp}Â°C`;
            }
            if (minTemp && weatherData.today.minTemp !== -9999) {
                minTemp.textContent = `æœ€ä½: ${weatherData.today.minTemp}Â°C`;
            }
            
            // 24æ™‚é–“äºˆå ±ã®è¡¨ç¤º
            displayForecast(weatherData.forecast.shortTerm.slice(0, 8)); // 8æ™‚é–“åˆ†
        }
        
        function displayMascotState(mascotState) {
            const mascotMood = document.getElementById('mascot-mood');
            if (mascotMood) {
                mascotMood.textContent = `æ°—åˆ†: ${mascotState.mood} (${mascotState.energy}%)`;
            }
            
            const energyBar = document.getElementById('energy-bar');
            if (energyBar) {
                setTimeout(() => {
                    energyBar.style.width = `${mascotState.energy}%`;
                }, 100);
            }
            
            const weatherReaction = document.getElementById('weather-reaction');
            if (weatherReaction) {
                weatherReaction.textContent = mascotState.weatherReaction;
            }
            
            const recommendations = document.getElementById('recommendations');
            if (recommendations && mascotState.recommendations) {
                recommendations.innerHTML = mascotState.recommendations
                    .map(rec => `<li>${rec}</li>`)
                    .join('');
            }
        }
        
        function displayForecast(forecastData) {
            const forecastGrid = document.getElementById('forecast-grid');
            if (!forecastGrid || !forecastData) return;
            
            forecastGrid.innerHTML = forecastData.map(forecast => {
                const date = new Date(forecast.date);
                const timeStr = date.toLocaleTimeString('ja-JP', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                return `
                    <div class="forecast-item">
                        <div class="forecast-time">${timeStr}</div>
                        <div class="forecast-temp">${forecast.temp}Â°C</div>
                        <div style="font-size: 12px; color: #888;">${forecast.prec}mm</div>
                    </div>
                `;
            }).join('');
        }
        
        function showError(message) {
            // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            const existingErrors = document.querySelectorAll('.error');
            existingErrors.forEach(error => error.remove());
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.weather-card'));
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®è¡¨ç¤º/éè¡¨ç¤º
        function showLoadingState() {
            const weatherName = document.getElementById('weather-name');
            const mascotMood = document.getElementById('mascot-mood');
            const weatherReaction = document.getElementById('weather-reaction');
            
            if (weatherName) weatherName.textContent = 'å¤©æ°—æƒ…å ±ã‚’å–å¾—ä¸­...';
            if (mascotMood) mascotMood.textContent = 'æ°—åˆ†: èª­ã¿è¾¼ã¿ä¸­...';
            if (weatherReaction) weatherReaction.textContent = 'ãƒã‚¹ã‚³ãƒƒãƒˆã®åå¿œã‚’å–å¾—ä¸­...';
        }

        function hideLoadingState() {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®è§£é™¤ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼‰
        }
        
        // éƒ½å¸‚å¤‰æ›´ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãï¼‰
        async function changeCity() {
            if (isLoading) {
                console.log('â³ æ—¢ã«èª­ã¿è¾¼ã¿ä¸­ã§ã™...');
                return;
            }

            const citySelect = document.getElementById('city-select');
            const selectedCity = citySelect.value;
            
            // ç¾åœ¨ã®éƒ½å¸‚ã¨åŒã˜å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (currentWeatherData && currentWeatherData.location === selectedCity) {
                console.log(`ğŸ“ ${selectedCity}ã¯æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã¾ã™`);
                return;
            }
            
            console.log(`ğŸ”„ éƒ½å¸‚å¤‰æ›´: ${selectedCity}`);
            
            // å‰å›ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
            }
            
            // 500mså¾Œã«å®Ÿè¡Œï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ - å°‘ã—é•·ã‚ã«ï¼‰
            loadingTimeout = setTimeout(() => {
                // å†åº¦isLoadingã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆç«¶åˆçŠ¶æ…‹ã‚’é˜²ãï¼‰
                if (!isLoading) {
                    loadWeatherData(selectedCity);
                }
            }, 500);
        }
        
        // å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆä¸¦è¡Œå‡¦ç† + ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ç®¡ç†ï¼‰
        async function loadWeatherData(city = 'tokyo') {
            if (isLoading) {
                console.log('â³ æ—¢ã«èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
                return;
            }

            // åŒä¸€éƒ½å¸‚ã®é‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
            if (currentWeatherData && currentWeatherData.location === city) {
                console.log(`ğŸ“ ${city}ã®ãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«å–å¾—æ¸ˆã¿ã§ã™`);
                return;
            }

            isLoading = true;
            const requestId = Date.now();
            console.log(`ğŸ”„ [${requestId}] ${city}ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹`);
            
            try {
                console.log(`ğŸŒ¤ï¸ ${city}ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...`);
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                showLoadingState();
                
                // å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã¨ãƒã‚¹ã‚³ãƒƒãƒˆçŠ¶æ…‹ã‚’ä¸¦è¡Œå–å¾—
                const [weatherData, mascotState] = await Promise.allSettled([
                    getWeatherByCity(city),
                    currentWeatherData ? updateMascotState(currentWeatherData) : Promise.resolve(null)
                ]);
                
                // å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
                if (weatherData.status === 'fulfilled' && weatherData.value) {
                    currentWeatherData = weatherData.value;
                    displayWeatherData(weatherData.value);
                    
                    // ãƒã‚¹ã‚³ãƒƒãƒˆçŠ¶æ…‹ãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã€å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°
                    if (!mascotState.value && weatherData.value) {
                        const newMascotState = await updateMascotState(weatherData.value);
                        if (newMascotState) {
                            currentMascotState = newMascotState;
                            displayMascotState(newMascotState);
                        }
                    }
                } else {
                    console.error('å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:', weatherData.reason);
                    showError('å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    hideLoadingState();
                    isLoading = false;
                    return;
                }
                
                // ãƒã‚¹ã‚³ãƒƒãƒˆçŠ¶æ…‹ã®å‡¦ç†
                if (mascotState.status === 'fulfilled' && mascotState.value) {
                    currentMascotState = mascotState.value;
                    displayMascotState(mascotState.value);
                }
                
                console.log(`âœ… [${requestId}] ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†`);
                hideLoadingState();
                
            } catch (error) {
                console.error(`âŒ [${requestId}] ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:`, error);
                showError('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                hideLoadingState();
            } finally {
                isLoading = false;
                console.log(`ğŸ”š [${requestId}] å‡¦ç†çµ‚äº†`);
            }
        }
        
        // ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆé€ä¿¡ä¸­ã®é‡è¤‡é˜²æ­¢ä»˜ãï¼‰
        let isSendingChat = false;
        
        async function sendChatMessage() {
            if (isSendingChat) {
                console.log('â³ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ä¸­ã§ã™...');
                return;
            }

            const chatInput = document.getElementById('chat-input');
            const chatResponse = document.getElementById('chat-response');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            isSendingChat = true;
            chatResponse.innerHTML = '<div class="loading">ãƒã‚¹ã‚³ãƒƒãƒˆãŒè€ƒãˆã¦ã„ã¾ã™...</div>';
            chatInput.value = '';
            chatInput.disabled = true;
            
            try {
                const response = await Promise.race([
                    chatWithMascot(message, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼', currentWeatherData),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')), 10000)
                    )
                ]);
                
                if (response) {
                    chatResponse.innerHTML = `
                        <div><strong>ãƒã‚¹ã‚³ãƒƒãƒˆ:</strong> ${response.response}</div>
                        ${response.suggestions && response.suggestions.length > 0 ? 
                          `<div style="margin-top: 10px; font-size: 14px; color: #666;">
                             ğŸ’¡ ææ¡ˆ: ${response.suggestions.join(', ')}
                           </div>` : ''
                        }
                    `;
                } else {
                    chatResponse.innerHTML = '<div class="error">å¿œç­”ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                }
            } catch (error) {
                console.error('ãƒãƒ£ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                if (error.message === 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ') {
                    chatResponse.innerHTML = '<div class="error">å¿œç­”ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</div>';
                } else {
                    chatResponse.innerHTML = '<div class="error">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
                }
            } finally {
                isSendingChat = false;
                chatInput.disabled = false;
                chatInput.focus();
            }
        }
        
        // åˆæœŸåŒ–å‡¦ç†ï¼ˆé‡è¤‡å®Ÿè¡Œé˜²æ­¢ï¼‰
        function initializeApp() {
            if (isInitialized) {
                console.log('âš ï¸  ã‚¢ãƒ—ãƒªã¯æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã§ã™');
                return;
            }

            console.log('ğŸš€ å¤©æ°—ãƒã‚¹ã‚³ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–ä¸­...');
            
            const chatInput = document.getElementById('chat-input');
            const citySelect = document.getElementById('city-select');
            
            if (!chatInput || !citySelect) {
                console.error('âŒ å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !isSendingChat) {
                    sendChatMessage();
                }
            });
            
            // éƒ½å¸‚é¸æŠã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãï¼‰
            citySelect.addEventListener('change', changeCity);
            
            isInitialized = true;
            console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®šå®Œäº†');
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰
            setTimeout(() => {
                if (!currentWeatherData && !isLoading) {
                    console.log('ğŸŒ¤ï¸ åˆæœŸå¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿é–‹å§‹');
                    loadWeatherData();
                } else {
                    console.log('ğŸ“‹ æ—¢ã«ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã¾ãŸã¯èª­ã¿è¾¼ã¿ä¸­ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
                }
            }, 200);
        }

        // DOMContentLoaded + ãƒªãƒ­ãƒ¼ãƒ‰å¯¾å¿œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // æ—¢ã«DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆãƒ©ã‚¤ãƒ–ãƒªãƒ­ãƒ¼ãƒ‰ç­‰ï¼‰
            initializeApp();
        }
    </script>
</body>
</html>